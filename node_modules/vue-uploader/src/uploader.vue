<style src="./style.less" lang="less"></style>
<template src="./template.html"></template>
<script>
    import {sizeConvert, trancateHead, trancateTail, percentage} from "./filters"
    import {validateCompress, getExtension} from "./util"
    import lrz from "./lrz.all.bundle"
    import UploadFile from "./UploadFile"
    export default {
        props: {
            //是否允许选择多个文件
            multiple: {
                type: Boolean,
                default: false
            },
            mimeTypes: {
                type: Array,
                default: ["*"]
            },
            //扩展名
            extensions: {
                type: Array,
                default: []
            },
            //是否隐藏
            hidden: {
                type: Boolean,
                default: false
            },
            //文件大小限制
            sizeLimit: {
                type: Number,
                default: 100 * 1024,
                validator(val){
                    return !isNaN(val) && val > 0
                }
            },
            //文件数量限制
            countLimit: {
                type: Number,
                default: 1,
                validator(val){
                    return !isNaN(val) && val > 0
                }
            },
            //服务器地址
            server: {
                type: String,
                required: true
            },
            //表单参数名称
            fieldName: {
                type: String,
                default: "file"
            },
            //压缩
            compress: {
                type: Object,
                validator(val){
                    return validateCompress(val)
                }
//              {
//                  //压缩后的最大宽度
//                  width: 1600,
//                  //压缩后的最大高度
//                   height: 1600,
//                  //jpeg质量
//                   quality: 80
//               }
            }
        },
        data(){
            return {
                list: [
//                    {
//                        name: "xxx.jpg",
//                        size: 15315315315315315,
//                        type: "",
//                        status: "ready",//error,finished,uploading,abort
//                        progress: 0.15,
//                        origin: {Bolb},
//                        extension:"jpg",
//                        md5:"21312dshjcy3hf3uyfuy334yuf3hif3",
//                        thumbnail:null
//                    }
                ]
            }
        },
        computed: {
            totalSize(){
                let size = 0
                for (let i = 0; i < this.list.length; i++) {
                    size += this.list[i].size
                }
                return size
            },
            overview(){
                return "一共" + this.list.length + "个文件," + sizeConvert(this.totalSize)
            },
            progress(){
                let progressSum = 0
                this.list.forEach(function (file) {
                    progressSum += file.progress
                })
                return (progressSum / this.list.length).toFixed(4)
            }
        },
        methods: {
            select(){
                this.$els.file.click()
            },
            add(e){
                let component = this
                let files = this.$els.file.files
                if (!files || !files.length) {
                    return
                }
                if (this.list.length + files.length > this.countLimit) {
                    alert("文件总数超出上限")
                    return
                }
                for (let i = 0; i < files.length; i++) {
                    let file = files[i]
                    if (file.size > component.sizeLimit) {
                        alert("单个文件不得超过" + sizeConvert(component.sizeLimit))
                        return
                    }
                    if (!component.checkExtension(file.name)) {
                        alert("不支持的文件扩展名")
                        return
                    }
                    if (component.isFileExist(file)) {
                        alert("文件已经存在")
                        return
                    }
                }

                for (let i = 0; i < files.length; i++) {
                    let file = files[i]
                    let uploadFile = new UploadFile(file)
                    component.list.push(uploadFile)
                    uploadFile._vm = component
                    uploadFile.makeThumbnail()
                    component.$dispatch("fileAdded", uploadFile)
                }
                this.$els.file.value = null
            },
            isFileExist(uf){
                for (let i = 0; i < this.list.length; i++) {
                    if (this.list[i].equals(uf)) {
                        return true
                    }
                }
                return false
            },
            startAll(){
                this.list.forEach(function (uf) {
                    uf.start()
                })
            },
            abortAll(){
                this.list.forEach(function (uf) {
                    uf.abort()
                })
            },
            removeAll(){
                let successCount = 0
                let arr = []
                this.list.forEach(function (uf) {
                    if (uf.status != 'uploading') {
                        arr.push(uf)
                    }
                })
                arr.forEach(function (uf) {
                    uf.remove() ? successCount++ : null
                })
                return successCount
            },
            //删除已完成
            removeFinished(){
                let arr = []
                this.list.forEach(function (uf) {
                    if (uf.status == 'finished') {
                        arr.push(uf)
                    }
                })
                arr.forEach(function (uf) {
                    uf.remove()
                })

            },
            checkExtension(fileName){
                return !this.extensions.length || this.extensions.includes(getExtension(fileName))
            }
        },
        filters: {sizeConvert, trancateHead, trancateTail, percentage}
    }
</script>